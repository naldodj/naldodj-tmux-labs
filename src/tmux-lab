#!/usr/bin/env bash

# ============================================================
# tmux-lab
# ------------------------------------------------------------
# Cria panes tmux e executa comandos específicos em cada um.
#
# USO:
#   tmux-lab <sessao> "cmd1" "cmd2" "cmd3" ...
#
# EXEMPLO:
#   tmux-lab relay \
#     "ncat -lv 80" \
#     "ncat -lv 443" \
#     "ncat 127.0.0.1 80" \
#     "htop"
#
# LÓGICA:
#   total panes = quantidade de comandos
#   splits = panes - 1
#
# FUNCIONAMENTO:
#   cria sessão
#   cria panes
#   aplica layout tiled
#   envia comando para cada pane
# ============================================================

SESSION="$1"
shift

if [ -z "$SESSION" ]; then
    echo "Uso: tmux-lab <sessao> \"cmd1\" \"cmd2\" ..."
    exit 1
fi

CMDS=("$@")
PANES=${#CMDS[@]}

if [ "$PANES" -lt 1 ]; then
    echo "Erro: informe ao menos 1 comando"
    exit 1
fi

SPLITS=$((PANES - 1))

# cria sessão
tmux new-session -d -s "$SESSION"

# cria panes
for ((i=1; i<=SPLITS; i++)); do
    if (( i % 2 == 1 )); then
        tmux split-window -h -t "$SESSION"
    else
        tmux split-window -v -t "$SESSION"
    fi
done

# layout grid
tmux select-layout -t "$SESSION" tiled

# envia comandos
for i in "${!CMDS[@]}"; do
    tmux send-keys -t "$SESSION.$i" "${CMDS[$i]}" C-m
done

# attach
tmux attach -t "$SESSION"